sap.ui.define(["nrg/base/view/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","jquery.sap.global","ute/ui/commons/Dialog","sap/ui/model/json/JSONModel","nrg/module/nnp/view/NNPPopup","sap/ui/model/odata/ODataUtils"],function(a,b,c,d,e,f,g,h){"use strict";var i=a.extend("nrg.module.campaign.view.SalesScript");return i.prototype.onInit=function(){},i.prototype.onAfterRendering=function(){},i.prototype.onBeforeRendering=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p=this.getOwnerComponent().getModel("comp-campaign"),q=this,r=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo(),s=q.getView().byId("idnrgRejectRsnsMD"),t=q.getView().byId("idnrgRejectRsnsTempl");this.getView().setModel(new sap.ui.model.json.JSONModel,"oEditEmailNNP"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEditEmailValidate"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oLocalModel"),this.getView().setModel(this.getOwnerComponent().getModel("comp-dashboard"),"oODataSvc"),m=this.getOwnerComponent().getModel("comp-i18n-campaign"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._sContract=r.parameters.coNum,this._sOfferCode=r.parameters.offercodeNum,this._sBP!==r.parameters.bpNum&&(this._sBP=r.parameters.bpNum,this._bFirstTime=!0,this._bScored=!1,this.getView().setModel(new sap.ui.model.json.JSONModel,"view-credit")),this._sCA=r.parameters.caNum,this._sType=r.parameters.stype,this._sPromo=r.parameters.sPromo,c="/CpgChgOfferS(Contract='"+this._sContract+"',OfferCode='"+this._sOfferCode+"',Promo='"+this._sPromo+"',Type='"+this._sType+"')",n=p.getContext(c),this._bindView(c),c+="/Scripts",g=["BP","EffectiveDate","EndDate","CurrOffer","CampaignCode","TxtName","AvailDate"],h=[this._sBP,n.getProperty("EffectDate"),n.getProperty("EndDate"),n.getProperty("CurrOffer"),n.getProperty("Campaign"),"MAND",n.getProperty("AvailDate")],b=this._createSearchFilterObject(g,h),e=this.getView().byId("idnrgCamSSDdL"),f=this.getView().byId("idnrgCamSSLngLtIt").clone(),i=this.getView().byId("idCamSSMdTv"),j=function(){p.create("/HttpLogS",{Contract:q._sContract,Send:o,Receive:new Date,Text:"MAND"},{success:function(){d.sap.log.info("Time logged succeefully")},error:function(){d.sap.log.info("Time logged failed")}}),k=e.getContent(),void 0!==k&&k.length>0&&(l=k[0].getBindingContext("comp-campaign").getPath(),e.setSelectedKey("EN"),i.bindElement({model:"comp-campaign",path:l})),q.getOwnerComponent().getCcuxApp().setOccupied(!1)},a={model:"comp-campaign",path:c,template:f,filters:b,parameters:{batchGroupId:"1"},events:{dataReceived:j}},o=new Date,e.bindAggregation("content",a),c="/RejectRsnS",a={model:"comp-campaign",path:c,template:t},s.bindAggregation("content",a)},i.prototype._bindView=function(a){this.getView().bindElement({model:"comp-campaign",path:a})},i.prototype._createSearchFilterObject=function(a,d){var e,f=[];for(e=0;e<a.length;e+=1)f.push(new b(a[e],c.EQ,d[e],""));return f},i.prototype.onAccept=function(){var a,b,c=this.getOwnerComponent().getModel("comp-campaign"),d=this,e=d.getView().getModel("view-credit");this._bScored||(this._bScored=!1),this.getOwnerComponent().getCcuxApp().setOccupied(!0),a="/PrepayS(Contract='"+this._sContract+"',OfferCode='"+this._sOfferCode+"',Scored="+h.formatValue(this._bScored,"Edm.Boolean")+")",b={success:function(b){if(d.getOwnerComponent().getCcuxApp().setOccupied(!1),b){if(d._bFirstTime||d._bScored!==b.Scored?(e.setData(b),d._bScored=b.Scored,d._bFirstTime=!1):(e.setProperty("/DisconnReqDep",b.DisconnReqDep),e.setProperty("/DepAmt",b.DepAmt)),a="/PrepayS(Contract='"+d._sContract+"',OfferCode='"+d._sOfferCode+"',Scored="+h.formatValue(d._bScored,"Edm.Boolean")+")","N"===b.Flag)return void d.onNNP();if("E"===b.Flag)return void ute.ui.main.Popup.Alert({title:"Change Campaign",message:b.Script});if("Y"===b.Flag){d._oSwapFragment||(d._oSwapFragment=sap.ui.xmlfragment("SwapScripts","nrg.module.campaign.view.SwapScript",d),d._oSwapFragment.setModel(c,"comp-campaign")),void 0===d._oSwapDialog&&(d._oSwapDialog=new ute.ui.main.Popup.create({title:"SWAP DEPOSIT SCRIPT",content:this._oSwapFragment}),d._oSwapDialog.addStyleClass("nrgCamOvs-dialog"),d._oSwapDialog.setShowCloseButton(!1));var f=sap.ui.core.Fragment.byId("SwapScripts","idnrgSwapDesc");return f.bindElement({model:"comp-campaign",path:a}),void d._oSwapDialog.open()}}}.bind(this),error:function(){d.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},c&&c.read(a,b)},i.prototype.onSwapYes=function(){var a,b,c=this.getOwnerComponent().getModel("comp-campaign"),d=this;this._PrepayAltPay=!1,this.getOwnerComponent().getCcuxApp().setOccupied(!0),a="/DepositS(Contract='"+this._sContract+"')",b={success:function(a){if(a)if(a.Proceed)d.onNNP(),d._oSwapDialog.close();else{var b=d.getOwnerComponent().getCcuxWebUiManager();b.notifyWebUi("openIndex",{LINK_ID:"Z_OT_PAYMT"})}d.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){d.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},c&&c.read(a,b)},i.prototype.onSwapNo=function(){this._PrepayAltPay=!1,this._oSwapDialog.close()},i.prototype.onSwapOther=function(){this._PrepayAltPay=!0,this._oSwapDialog.close(),this.onNNP()},i.prototype.onNNP=function(){var a,b,c=this.getOwnerComponent().getModel("comp-campaign"),e=new g,f=this.getOwnerComponent().getGlobalDataManager();f.isREBS()?this.invokeOverviewScript():(e.attachEvent("NNPCompleted",this.invokeOverviewScript,this),this.getView().addDependent(e),this.getOwnerComponent().getCcuxApp().setOccupied(!0),a="/NNPS('"+this._sBP+"')",b={success:function(a){e.openNNP(a.BP,a.Email,a.ConsNum),d.sap.log.info("Odata Read Successfully:::")}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!0),d.sap.log.info("NNP Error occured")}.bind(this)},c&&c.read(a,b))},i.prototype.invokeOverviewScript=function(){var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q=this,r=this.getOwnerComponent().getModel("comp-campaign"),s=q.getView().byId("idnrgRejectRsnsTempl");this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("OverViewScripts","nrg.module.campaign.view.OverviewScript",this)),this._oDialogFragment.setModel(r,"view-campaign"),void 0===this._oOverviewDialog&&(this._oOverviewDialog=new ute.ui.main.Popup.create({title:"OVERVIEW SCRIPT",close:this._handleDialogClosed,content:this._oDialogFragment}),this._oOverviewDialog.setShowCloseButton(!1)),a="/CpgChgOfferS(Contract='"+this._sContract+"',OfferCode='"+this._sOfferCode+"',Promo='"+this._sPromo+"',Type='"+this._sType+"')",n=r.getContext(a),l=["BP","EffectiveDate","EndDate","CurrOffer","CampaignCode","TxtName"],m=[this._sBP,n.getProperty("EffectDate"),n.getProperty("EndDate"),n.getProperty("CurrOffer"),n.getProperty("Campaign"),"OVW"],f=this._createSearchFilterObject(l,m),a+="/Scripts",this._oOverviewDialog.setWidth("750px"),this._oOverviewDialog.setHeight("auto"),this._oOverviewDialog.addStyleClass("nrgCamOvs-dialog"),k=sap.ui.core.Fragment.byId("OverViewScripts","idnrgCamOvsOvTv"),b=sap.ui.core.Fragment.byId("OverViewScripts","idnrgCamOvsDdL"),g=b.getContent(),c=this.getView().byId("idnrgCamSSLngLtItOv").clone(),j=function(){r.create("/HttpLogS",{Contract:q._sContract,Send:p,Receive:new Date,Text:"OVW"},{success:function(){d.sap.log.info("Time logged succeefully")},error:function(){d.sap.log.info("Time logged failed")}}),g=b.getContent(),void 0!==g&&g.length>0&&(i=g[0].getBindingContext("view-campaign").getPath(),b.setSelectedKey("EN"),k.bindElement({model:"view-campaign",path:i})),q._oOverviewDialog.open(),h.detachDataReceived(j),q.getOwnerComponent().getCcuxApp().setOccupied(!1)},e={model:"view-campaign",path:a,template:c,filters:f,parameters:{batchGroupId:"1"},events:{dataReceived:j}},p=new Date,b.bindAggregation("content",e),h=b.getBinding("content"),o=sap.ui.core.Fragment.byId("OverViewScripts","idnrgRejectRsnsOV"),s=q.getView().byId("idnrgRejectRsnsTemplOV"),a="/RejectRsnS",e={model:"view-campaign",path:a,template:s},o.bindAggregation("content",e),this.getOwnerComponent().getCcuxApp().setOccupied(!1)},i.prototype.backToOverview=function(){this.navTo("campaign",{bpNum:this._sBP,caNum:this._sCA,coNum:this._sContract,typeV:"C"})},i.prototype.formatType=function(a){var b=this.getOwnerComponent().getModel("comp-i18n-campaign");return b.getProperty("EN"===a?"nrgCmpSSEN":"nrgCmpSSES")},i.prototype.onMandLngSelected=function(a){var b,c,d=this.getView().byId("idCamSSMdTv"),e=(this.getOwnerComponent().getModel("comp-campaign"),this.getView().byId("idnrgCamSSDdL"));c=a.getSource().getProperty("selectedKey"),e&&e.getContent()&&e.getContent().forEach(function(a){var d=a.getBindingContext("comp-campaign");c===d.getProperty("TxtLang")&&(b=d.getPath())}),b&&d.bindElement({model:"comp-campaign",path:b})},i.prototype.onOvwLngSelected=function(a){var b,c,d=sap.ui.core.Fragment.byId("OverViewScripts","idnrgCamOvsOvTv"),e=sap.ui.core.Fragment.byId("OverViewScripts","idnrgCamOvsDdL");c=a.getSource().getProperty("selectedKey"),e&&e.getContent()&&e.getContent().forEach(function(a){var d=a.getBindingContext("view-campaign");c===d.getProperty("TxtLang")&&(b=d.getPath())}),d.bindElement({model:"view-campaign",path:b})},i.prototype.onRejectionReason=function(){},i.prototype.onOvsAccept=function(){var a,b,c,e,f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=this,D=this.getView().getModel("view-credit");a=this.getOwnerComponent().getModel("comp-campaign"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),j="/CpgChgOfferS(Contract='"+this._sContract+"',OfferCode='"+this._sOfferCode+"',Promo='"+this._sPromo+"',Type='"+this._sType+"')",k=a.getContext(j),c=k.getProperty("Campaign"),v=k.getProperty("EffectDate"),e=k.getProperty("OfferCode"),f=k.getProperty("OfferTitle"),g=k.getProperty("Promo"),i=k.getProperty("Contract"),l=k.getProperty("PromoRank"),m=k.getProperty("Brand"),o=k.getProperty("Type"),p=k.getProperty("AvailDate"),q=this.getOwnerComponent().getModel("comp-campLocal"),r=q.getProperty("/LPCode"),s=q.getProperty("/firstName"),t=q.getProperty("/lastName"),u=q.getProperty("/lprefId"),n=this._sCA,w=D.getProperty("/CreditDate"),x=D.getProperty("/CreditRTG"),y=D.getProperty("/CreditScore"),z=D.getProperty("/CreditSource"),A=D.getProperty("/DepAmt"),B=D.getProperty("/DisconnReqDep"),b={method:"POST",urlParameters:{BP:this._sBP,Brand:m,BusinessRole:"ZU_CALL_CTR",CA:n,CampaignCode:h.formatValue(c,"Edm.Boolean"),ConnID:"",Contract:i,CreditDate:w||new Date,CreditRTG:x,CreditScore:y,CreditSource:z,DepAmt:A,DisconnReqDep:B,EffectDate:v,LP_Code:r,LP_FirstName:s,LP_LastName:t,LP_RefID:u,OfferCode:e,OfferTitle:f,PrepayAltPay:this._PrepayAltPay||!1,PromoCode:g,PromoRank:l,Type:o,AvailDate:p||new Date},success:function(a){var b;return d.sap.log.info("Odata Read Successfully:::"+a.Code),void 0!==a&&"S"===a.Code?(C.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"SWAP is completed"}),b=C.getOwnerComponent().getCcuxWebUiManager(),b.notifyWebUi("openIndex",{LINK_ID:"ZVASOPTSLN",REF_ID:"ENROLL",CONTRACT_ID:i}),void this.navTo("campaign",{bpNum:C._sBP,caNum:C._sCA,coNum:C._sContract,typeV:"P"})):(C.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"SWAP Failed"}),void this.navTo("campaignoffers",{bpNum:C._sBP,caNum:C._sCA,coNum:C._sContract,typeV:"N"}))}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"SWAP Failed"}),this.navTo("campaignoffers",{bpNum:C._sBP,caNum:C._sCA,coNum:C._sContract,typeV:"N"})}.bind(this)},a.callFunction("/AcceptCampaign",b),this._oOverviewDialog.close()},i.prototype.onOvsDecline=function(){this._oOverviewDialog.close(),this.navTo("campaignoffers",{bpNum:this._sBP,caNum:this._sCA,coNum:this._sContract,typeV:"N"})},i.prototype.onOVSDisposition=function(a){this._oOverviewDialog.close(),this.onDisposition(a)},i.prototype.onDisposition=function(a){var b,c,e,f,g,h,i,j,k,l,m,n,o=this.getOwnerComponent().getModel("comp-campaign"),p=this;this.getOwnerComponent().getCcuxApp().setOccupied(!0),b="/CpgChgOfferS(Contract='"+this._sContract+"',OfferCode='"+this._sOfferCode+"',Promo='"+this._sPromo+"',Type='"+this._sType+"')",e=o.getContext(b),g=e.getProperty("Campaign"),f=e.getProperty("Brand"),i=e.getProperty("OfferCode"),h=this._sCA,n=e.getProperty("Promo"),j=a.mParameters.selectedKey,k=e.getProperty("PromoRank"),l=e.getProperty("Contract"),m=e.getProperty("Type"),c={method:"POST",urlParameters:{Brand:f,CA:h,CampaignCode:g,Contract:l,DispoCode:j,OfferCode:i,PromoCode:n,PromoRank:k,Type:m},success:function(a){void 0!==a&&"S"===a.Code?(this.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"Disposition process is completed"}),this.navTo("campaignoffers",{bpNum:p._sBP,caNum:p._sCA,coNum:p._sContract,typeV:"N"})):(this.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"Disposition process is Failed"}),this.navTo("campaignoffers",{bpNum:p._sBP,caNum:p._sCA,coNum:p._sContract,typeV:"N"})),d.sap.log.info("Odata Read Successfully:::"+a.Code)}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Change Campaign",message:"Disposition process is Failed"})}.bind(this)},o.callFunction("/RejectCampaign",c)},i});