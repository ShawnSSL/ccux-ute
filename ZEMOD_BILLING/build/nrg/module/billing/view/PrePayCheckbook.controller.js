sap.ui.define(["jquery.sap.global","nrg/base/view/BaseController","nrg/base/type/Price","nrg/module/quickpay/view/QuickPayPopup","nrg/module/billing/view/EligPopup","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(a,b,c,d,e,f,g){"use strict";var h=b.extend("nrg.module.billing.view.PrePayCheckbook");return h.prototype.onInit=function(){this.getOwnerComponent().getCcuxApp().setTitle("BILLING")},h.prototype.onBeforeRendering=function(){this.getView().setModel(this.getOwnerComponent().getModel("comp-billing"),"oDataSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-eligibility"),"oDataEligSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPpChkbkHdr"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPpPmtHdr"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oAdjustmentInfo"),this._initRoutingInfo(),this._initPpChkbookHdr(),this._initPpPmtHdr(),this._retrieveNotification()},h.prototype._initRoutingInfo=function(){var a=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum},h.prototype._formatBoolIsAdjustment=function(a){return"Adjustment"===a||"adjustment"===a||"ADJUSTMENT"===a?!0:!1},h.prototype._formatBoolIsNotAdjustment=function(a){return"Adjustment"===a||"adjustment"===a||"ADJUSTMENT"===a?!1:!0},h.prototype._formatDate=function(a){var b;return a?b=(a.getMonth()+1).toString()+"/"+a.getDate().toString()+"/"+a.getFullYear().toString().substring(2,4):null},h.prototype._formatBoolCredit=function(a){return parseInt(a,10)>0?!0:!1},h.prototype._formatBoolDebit=function(a){return parseInt(a,10)<=0?!0:!1},h.prototype._onAdjustmentClicked=function(a){var b,c,d=this.getView().getModel("oPpPmtHdr"),e=a.getSource().mBindingInfos.text.binding.oContext.sPath,f=[];f=e.split("/"),b=d.oData.results[f[2]].PpPmtItmes.results[f[5]].ActKey,c=d.oData.results[f[2]].PpPmtItmes.results[f[5]].SortKey,this._oPpAdjustmentInfoPopup||(this._oPpAdjustmentInfoPopup=ute.ui.main.Popup.create({content:sap.ui.xmlfragment(this.getView().sId,"nrg.module.billing.view.PrePayAdjustment",this),title:"Adjustment Info"}),this.getView().addDependent(this._oPpAdjustmentInfoPopup),this._oPpAdjustmentInfoPopup.addStyleClass("nrgBilling-prepayAdj")),this._oPpAdjustmentInfoPopup.open(),this._loadAdjustmentInfo(b,c)},h.prototype._loadAdjustmentInfo=function(a,b){var c,d,e,f,g,h,i=this.getView().getModel("oDataSvc");d="/PrePayInvDetails",e=["CA","ActKey","SortKey"],f=[this._caNum,a,b],g=this._createSearchFilterObject(e,f),c={filters:g,success:function(a){a&&(h=JSON.parse(a.results[0].Subtot),a.results.subTotal=h,this.getView().getModel("oAdjustmentInfo").setData(a)),this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},i&&(this.getOwnerComponent().getCcuxApp().setOccupied(!0),i.read(d,c))},h.prototype._createSearchFilterObject=function(a,b){var c,d=[];for(c=0;c<a.length;c+=1)d.push(new f(a[c],g.EQ,b[c],""));return d},h.prototype._onPpPmtHdrClicked=function(a){var b,c=this.getView().getModel("oPpPmtHdr");b=a.oSource.oBindingContexts.oPpPmtHdr.getPath(),c.getProperty(b+"/bExpand")&&this._retrPpPmtItmes(c.getProperty(b).ActKey,b)},h.prototype._onPaymentOptionsClick=function(){var a=new d;this.getView().addDependent(a),this._coNum&&a.openQuickPay(this._coNum,this._bpNum,this._caNum),a.attachEvent("PaymentCompleted",function(){this._initPpChkbookHdr(),this._initPpPmtHdr()},this)},h.prototype._onHighBillFactorClick=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.HighBill",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.HighBillNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onBackToBilling=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.BillingPrePaid",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.BillingPrePaidNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._initPpChkbookHdr=function(){var a;a="/PrePayHeaders(ContractAccountNumber='"+this._caNum+"',InvNumber='')",this._retrPpChkbookHdr(a)},h.prototype._initPpPmtHdr=function(){var a;a="/ConfBuags('"+this._caNum+"')/PrePayPmtHdrs",this._retrPpPmtHdr(a)},h.prototype._retrPpPmtItmes=function(a,b){var c,d,e=this.getView().getModel("oDataSvc");d="/PrePayPmtHdrs(ContractAccountNumber='"+this._caNum+"',ActKey='"+a+"')/PrePayPmtItems",c={success:function(a){a&&this.getView().getModel("oPpPmtHdr").setProperty(b+"/PpPmtItmes",a),this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},e&&e.read(d,c)},h.prototype._retrPpChkbookHdr=function(a){var b,c=this.getView().getModel("oDataSvc");b={success:function(a){a&&this.getView().getModel("oPpChkbkHdr").setData(a),this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},c&&c.read(a,b)},h.prototype._retrPpPmtHdr=function(a){var b,c,d=this.getView().getModel("oDataSvc");b={success:function(a){if(a){for(c=0;c<a.results.length;c+=1)c!==a.results.length-1?a.results[c].bExpand=!1:(a.results[c].bExpand=!0,this._retrPpPmtItmes(a.results[c].ActKey,"/results/"+c.toString()));this.getView().getModel("oPpPmtHdr").setData(a),this.getOwnerComponent().getCcuxApp().setOccupied(!1)}}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},d&&d.read(a,b)},h.prototype._retrieveNotification=function(){var a,b,c,d="/EligCheckS('"+this._coNum+"')",e=this.getView().getModel("oDataEligSvc"),f=this.getView().getModel("oEligibility"),g=this.getOwnerComponent().getModel("comp-i18n-billing");a={success:function(a){f.setData(a);var d=this.getView().byId("idnrgBilling-ppChkBk-notifications");for(d&&d.getContent()&&d.getContent().length>0&&d.removeAllContent(),this._eligibilityAlerts=[],b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:g.getProperty(a.ABPElig?"nrgNotfABPT":"nrgNotfABPF"),linkPress:this._openEligABPPopup.bind(this)}),this._eligibilityAlerts.push(b),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:g.getProperty(a.EXTNElig?"nrgNotfEXTT":"nrgNotfEXTF"),linkPress:this._openEligEXTNPopup.bind(this)}),this._eligibilityAlerts.push(b),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:g.getProperty(a.RBBElig?"nrgNotfRBPT":"nrgNotfRBPF"),linkPress:this._openEligRBBPopup.bind(this)}),this._eligibilityAlerts.push(b),b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty(a.DPPElig?"nrgNotfDPPT":"nrgNotfDPPF")}),this._eligibilityAlerts.push(b),a.EXTNPend&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty("nrgNotfPE")}),this._eligibilityAlerts.push(b)),a.CollAccActv&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty("nrgNotfCB")}),this._eligibilityAlerts.push(b)),a.CSAActv&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty("nrgNotfCSA")}),this._eligibilityAlerts.push(b)),a.RBankDActv&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty("nrgNotfRBD")}),this._eligibilityAlerts.push(b)),a.RCCardActv&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:g.getProperty("nrgNotfRCC")}),this._eligibilityAlerts.push(b)),c=0;c<this._eligibilityAlerts.length;c+=1)this._eligibilityAlerts[c].placeAt(d)}.bind(this),error:function(){}.bind(this)},e&&this._coNum&&e.read(d,a)},h.prototype._openEligABPPopup=function(){this.EligABPPopupCustomControl||(this.EligABPPopupCustomControl=new e({eligType:"ABP"}),this.EligABPPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligABPPopupCustomControl),this.EligABPPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - AVERAGE BILLING PLAN")),this.EligABPPopupCustomControl.prepare()},h.prototype._openEligEXTNPopup=function(){this.EligEXTNPopupCustomControl||(this.EligEXTNPopupCustomControl=new e({eligType:"EXTN"}),this.EligEXTNPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligEXTNPopupCustomControl),this.EligEXTNPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - EXTENSION")),this.EligEXTNPopupCustomControl.prepare()},h.prototype._openEligRBBPopup=function(){this.EligRBBPopupCustomControl||(this.EligRBBPopupCustomControl=new e({eligType:"RBB"}),this.EligRBBPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligRBBPopupCustomControl),this.EligRBBPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - RETRO BILLING PLAN")),this.EligRBBPopupCustomControl.prepare()},h});