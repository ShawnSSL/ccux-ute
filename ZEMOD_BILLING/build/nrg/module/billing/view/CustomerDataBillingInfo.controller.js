sap.ui.define(["jquery.sap.global","nrg/base/view/BaseController","sap/ui/model/json/JSONModel","nrg/module/quickpay/view/QuickPayPopup","nrg/base/type/Price","sap/ui/model/Filter","sap/ui/model/FilterOperator","nrg/module/billing/view/ABPPopup","nrg/module/dashboard/view/ReconnectPopup"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=b.extend("nrg.module.billing.view.CustomerDataBillingInfo");return j.prototype.onBeforeRendering=function(){this.getOwnerComponent().getCcuxApp().setTitle("BILLING"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._initRoutingInfo();var a=(this.getOwnerComponent().getModel("comp-feeAdjs"),this),b=this.getOwnerComponent().getGlobalDataManager();b.isPrepay()?a._coNum?a.navTo("billing.BillingPrePaid",{bpNum:a._bpNum,caNum:a._caNum,coNum:a._coNum}):a.navTo("billing.BillingPrePaidNoCo",{bpNum:a._bpNum,caNum:a._caNum}):a.PostPaidAccounts()},j.prototype.PostPaidAccounts=function(){this.getView().setModel(this.getOwnerComponent().getModel("comp-billing"),"oDataSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-billing-invoice"),"oDataInvoiceSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-eligibility"),"oDataEligSvc"),this.getView().setModel(this.getOwnerComponent().getModel("comp-feeAdjs"),"oDataBillingSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oBillingInvoices"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtSummary"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtPayments"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPmtItems"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oDisconInfo"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectInfo"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectFilters"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oInvoiceSelectDateRange"),this._initRetrBillInvoices(),this._initBillingMsgs(),this._initPostInvoice(),this._retreInvoiceNotification(),this._retrDiscInfo(),$(document).on("keydown",function(a){8!==a.which||$(a.target).is("input, textarea")||a.preventDefault()})},b.prototype._onReconnectionClick=function(){this.ReconnectPopupControl||(this.ReconnectPopupControl=new i({isRetro:!0}),this.ReconnectPopupControl.attachEvent("ReConnectCompleted",function(){},this),this.getView().addDependent(this.ReconnectPopupControl)),this.ReconnectPopupControl.open()},j.prototype.onAfterRendering=function(){this.getOwnerComponent().getCcuxApp().setLayout("FullWidthTool"),this.getOwnerComponent().getCcuxApp().showNavLeft(!0),this.getOwnerComponent().getCcuxApp().detachNavRightAll(),this.getOwnerComponent().getCcuxApp().attachNavLeft(this._navLeftCallBack,this)},b.prototype._navLeftCallBack=function(){var a=this.getOwnerComponent().getRouter();this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCaCo",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):!this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCa",{bpNum:this._bpNum,caNum:this._caNum}):this._coNum||this._caNum||!this._bpNum||a.navTo("dashboard.Verification",{bpNum:this._bpNum})},j.prototype._initBillingMsgs=function(){var a,b,c,d,e,f=this.getView().byId("idnrgBillingMsgs"),g=this.getView().byId("idnrgBillingMsgsTemp"),h=this.getView().byId("idnrgBilDunMsgs"),i=this.getView().byId("idnrgBilDunMsgsTemp"),j="/AlertsSet";f.unbindAggregation("content",!1),h.unbindAggregation("content",!1),a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"BILLING"],c=this._createSearchFilterObject(a,b),d={model:"comp-billing",path:j,template:g,filters:c},f.bindAggregation("content",d),a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"DUNNING"],c=this._createSearchFilterObject(a,b),e={model:"comp-billing",path:j,template:i,filters:c},h.bindAggregation("content",e)},b.prototype._createSearchFilterObject=function(a,b){var c,d=[];for(c=0;c<a.length;c+=1)d.push(new f(a[c],g.EQ,b[c],""));return d},j.prototype.onExit=function(){},j.prototype._initRoutingInfo=function(){var a=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum},j.prototype._initPostInvoice=function(){var a,b,c,d,e,f=this.getView().byId("idnrgBillPostInvoice"),g=this.getView().byId("idnrgBillPostInvoiceTemp"),h=function(){};a="/PostInvoices",this._coNum?(c=["ContractAccountNumber","IsCheckBook","Contract"],d=[this._caNum,!1,this._coNum]):(c=["ContractAccountNumber","IsCheckBook"],d=[this._caNum,!1]),e=this._createSearchFilterObject(c,d),b={model:"comp-billing",path:a,template:g,filters:e,events:{dataReceived:h}},f.bindAggregation("content",b)},j.prototype._initRetrBillInvoices=function(){var a,b,c=this.getView().getModel("oDataSvc");a="/BillInvoices('"+this._caNum+"')",b={success:function(a){a&&(this.getView().getModel("oBillingInvoices").setData(a),this._curInvNum=a.InvoiceNum,a.InvoiceNum?this._initRetrInvoiceDetail(this._curInvNum):this.getOwnerComponent().getCcuxApp().setOccupied(!1))}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},c&&c.read(a,b)},j.prototype._initRetrInvoiceDetail=function(a){this._retrInvSumry(a),this._retrInvPmts(a),this._retrInvItems(a)},j.prototype._retrInvSumry=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/PaymentSumry",c={success:function(a){this.getOwnerComponent().getCcuxApp().setOccupied(!1),a&&this.getView().getModel("oPmtSummary").setData(a.results[0])}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},d&&a&&d.read(b,c)},j.prototype._retrInvPmts=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/Payments",c={success:function(a){a&&this.getView().getModel("oPmtPayments").setData(a)}.bind(this),error:function(){}.bind(this)},d&&a&&d.read(b,c)},j.prototype._retrInvItems=function(a){var b,c,d=this.getView().getModel("oDataSvc");b="/PaymentHdrs('"+a+"')/PaymentItems",c={success:function(a){a&&this.getView().getModel("oPmtItems").setData(a)}.bind(this),error:function(){}.bind(this)},d&&a&&d.read(b,c)},j.prototype._retrDiscInfo=function(){var a=this.getView().getModel("oDataBillingSvc"),b="/DisconnectInfos('"+this._caNum+"')",c={success:function(a){a&&this.getView().getModel("oDisconInfo").setData(a)}.bind(this),error:function(){}.bind(this)};a&&a.read(b,c)},j.prototype._formatBoolCurChrg=function(a){return"X"===a||"x"===a?!0:!1},j.prototype._formatleftDisplayValue=function(a,b,c){return a&&0!==parseFloat(a)||b&&0!==parseFloat(b)?a?parseFloat(a).toFixed(2):"":c.toUpperCase().indexOf("PERIOD")>=0?"":void 0},j.prototype._formatRightDisplayValue=function(a,b,c){return a&&0!==parseFloat(a)||b&&0!==parseFloat(b)?b?parseFloat(b).toFixed(2):"0.00":c.toUpperCase().indexOf("PERIOD")>=0?"":void 0},j.prototype._formatleftValue=function(a,b,c){return"X"===a||"x"===a?!1:b&&0!==parseFloat(b)?!0:c&&0!==parseFloat(c)?!1:!0},j.prototype._formatRightValue=function(a,b,c){return"X"===a||"x"===a?!1:b&&0!==parseFloat(b)?!1:c&&0!==parseFloat(c)?!0:!1},j.prototype._formatVisElig=function(a){return"Y"===a||"y"===a?!0:!1},j.prototype._onInvoiceAmntClicked=function(){var a=this.getOwnerComponent().getModel("comp-i18n-billing"),b=a.getProperty("nrgBilling-paymentsPopup-ACCOUNT_SUMMARY");this._oInvoicePopup||(this._oInvoicePopup=sap.ui.xmlfragment("PaymentPopup","nrg.module.billing.view.InvoicePopup",this),this._oInvoicePopup=ute.ui.main.Popup.create({content:this._oInvoicePopup,title:b}),this._oInvoicePopup.setShowCloseButton(!0),this.getView().addDependent(this._oInvoicePopup)),this._oInvoicePopup.open(),this._curInvNum&&this._initRetrInvoiceDetail(this._curInvNum)},j.prototype.onPayNow=function(){var a=new d,b=this;this._sContract=this._coNum,this._sBP=this._bpNum,this._sCA=this._caNum,this.getView().addDependent(a),a.openQuickPay(this._sContract,this._sBP,this._sCA),a.attachEvent("PaymentCompleted",function(){b._initRetrBillInvoices(),b._initPostInvoice(),b._initBillingMsgs()},this)},j.prototype._onChkbookLnkClicked=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.CheckBook",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.CheckBookNoCo",{bpNum:this._bpNum,caNum:this._caNum})},j.prototype._onHighbillLnkClicked=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.HighBill",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.HighBillNoCo",{bpNum:this._bpNum,caNum:this._caNum})},j.prototype._onInvoiceNumClicked=function(){var a=this.getView().getModel("oBillingInvoices");a.oData.InvUrl&&window.open(a.oData.InvUrl,"_blank")},j.prototype._retreInvoiceNotification=function(){var a,b="/EligCheckS('"+this._coNum+"')",c=this.getView().getModel("oDataEligSvc"),d=this.getView().getModel("oEligibility");a={success:function(a){d.setData(a)}.bind(this),error:function(){}.bind(this)},c&&this._coNum&&c.read(b,a)},j.prototype._onInvoiceSelectClicked=function(){var a,b,c=!1;this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._oInvSelectPopup||(this._oInvSelectPopup=ute.ui.main.Popup.create({content:sap.ui.xmlfragment(this.getView().sId,"nrg.module.billing.view.InvSelectPopup",this),title:"INVOICE SELECTION"}),this._oInvSelectPopup.addStyleClass("nrgBilling-invSelectPopup"),this.getView().addDependent(this._oInvSelectPopup),this.getView().byId("nrgBilling-invSel-stDate").attachBrowserEvent("select",this._handleStartDateChange,this),this.getView().byId("nrgBilling-invSel-edDate").attachBrowserEvent("select",this._handleEndDateChange,this),a=new Date,a.setMonth(a.getMonth()-18),this.getView().byId("nrgBilling-invSel-stDate").setMinDate(a),this.getView().byId("nrgBilling-invSel-edDate").setMinDate(a)),this._oInvSelectPopup.open(),this._retrieveInvoiceInfo(this._caNum,function(){c=!0}),b=setInterval(function(){c&&(this.getOwnerComponent().getCcuxApp().setOccupied(!1),this._initializeFilters(),this._initializeDateRange(),clearInterval(b))}.bind(this),100)},j.prototype._retrieveInvoiceInfo=function(a,b){var c,d,e,h,i,j="/InvoiceS",k=[],l=this.getView().getModel("oDataInvoiceSvc"),m=this.getView().getModel("oInvoiceSelectInfo");k.push(new f({path:"ContAccount",operator:g.EQ,value1:a})),c={filters:k,success:function(a){if(a.results){for(m.setData(a.results),e=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=e.getContent().length,h=0;d>h;h+=1)e.removeContent(0);for(i=0;i<m.oData.length;i+=1){m.oData[i].View=!1;var c=new ute.ui.commons.Tag({elem:"div"}).addStyleClass("nrgBilling-invSelPopup-tableRow");(i+1)%2===0&&c.addStyleClass("nrgBilling-invSelPopup-tableRow-even"),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].Date}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("date")),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].PrintDoc}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("number")),c.addContent(new ute.ui.commons.Tag({elem:"div",text:m.oData[i].DataType}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("description")),c.addContent(new ute.ui.main.Checkbox({checked:m.oData[i].View}).addStyleClass("nrgBilling-invSelPopup-tableRow-item").addStyleClass("view")),e.addContent(c)}b&&b()}}.bind(this),error:function(){}.bind(this)},l&&l.read(j,c)},j.prototype._initializeFilters=function(){var a=this.getView().getModel("oInvoiceSelectFilters");a.setProperty("/All",!1),a.setProperty("/Disconnect",!1),a.setProperty("/Invoice",!1),a.setProperty("/Reversal",!1)},j.prototype._initializeDateRange=function(){var a,b,c=this.getView().getModel("oInvoiceSelectDateRange"),d=new Date,e=new Date;a=this._formatInvoiceDate(d.getDate(),d.getMonth()+1,d.getFullYear()),e.setMonth(e.getMonth()-12),b=this._formatInvoiceDate(e.getDate(),e.getMonth()+1,e.getFullYear()),this.getView().byId("nrgBilling-invSel-stDate").setDefaultDate(b),this.getView().byId("nrgBilling-invSel-edDate").setDefaultDate(a),c.setProperty("/Start",b),c.setProperty("/End",a),this._filterByDateRange()},j.prototype._formatInvoiceDate=function(a,b,c){return 10>a&&(a="0"+a),10>b&&(b="0"+b),b+"/"+a+"/"+c},j.prototype._deformatInvoiceDate=function(a){var b=a.split("/");return new Date(b[2],b[0]-1,b[1])},j.prototype._filterByDateRange=function(){var a,b,c,d=this.getView().byId("nrgBilling-invSelPopup-tableBody"),e=this.getView().getModel("oInvoiceSelectDateRange"),f=this.getView().getModel("oInvoiceSelectFilters");for(a=0;a<d.getContent().length;a+=1)b=d.getContent()[a].getContent()[0].getText(),d.getContent()[a].setVisible(this._deformatInvoiceDate(b)<this._deformatInvoiceDate(e.oData.Start)||this._deformatInvoiceDate(b)>this._deformatInvoiceDate(e.oData.End)?!1:!0);for(c in f.oData)"All"!==c&&f.setProperty("/"+c,!1)},j.prototype._handleStartDateChange=function(){var a=this.getView().getModel("oInvoiceSelectDateRange"),b=this.getView().byId("nrgBilling-invSel-stDate").getValue();a.setProperty("/Start",b),this._filterByDateRange()},j.prototype._handleEndDateChange=function(){var a=this.getView().getModel("oInvoiceSelectDateRange"),b=this.getView().byId("nrgBilling-invSel-edDate").getValue();a.setProperty("/End",b),this._filterByDateRange()},j.prototype._onSelectAll=function(){var a,b,c=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=this.getView().getModel("oInvoiceSelectFilters");for(a=0;a<c.getContent().length;a+=1)b=c.getContent()[a].getContent()[3],b.setChecked(d.oData.All)},j.prototype._onSelectDisconnect=function(){this._applyTypeFilter("Disconnect")},j.prototype._onSelectInvoice=function(){this._applyTypeFilter("Invoice")},j.prototype._onSelectReversed=function(){this._applyTypeFilter("Reversal")},j.prototype._applyTypeFilter=function(a){var b,c,d,e,f,g=this.getView().byId("nrgBilling-invSelPopup-tableBody"),h=this.getView().getModel("oInvoiceSelectFilters"),i=this.getView().getModel("oInvoiceSelectDateRange");for(d=0;d<g.getContent().length;d+=1)e=g.getContent()[d].getContent()[0].getText(),b=!1,c=!1,g.getContent()[d].getContent()[2].getText()!==a&&h.oData[a]||(b=!0),this._deformatInvoiceDate(e)>=this._deformatInvoiceDate(i.oData.Start)&&this._deformatInvoiceDate(e)<=this._deformatInvoiceDate(i.oData.End)&&(c=!0),g.getContent()[d].setVisible(b&&c?!0:!1);for(f in h.oData)"All"!==f&&f!==a&&h.setProperty("/"+f,!1)},j.prototype._onOpenBtnClick=function(){var a,b,c=this.getView().byId("nrgBilling-invSelPopup-tableBody"),d=this.getView().getModel("oInvoiceSelectInfo");for(a=0;a<c.getContent().length;a+=1)b=c.getContent()[a].getContent()[3],b.getChecked()&&c.getContent()[a].getVisible()&&this._openNewWindowDelayed(d.oData[a].URL)},j.prototype._openNewWindowDelayed=function(a){setTimeout(function(){window.open(a,"_blank")},1e3)},b.prototype.onDPPActive=function(){this.navTo("billing.DefferedPmtPlan",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum})},b.prototype.onABPActive=function(){this.ABPPopupCustomControl?this.ABPPopupCustomControl._oABPPopup.setTitle("AVERAGE BILLING PLAN"):(this.ABPPopupCustomControl=new h({isRetro:!1}),this.ABPPopupCustomControl.attachEvent("ABPCompleted",function(){},this),this.getView().addDependent(this.ABPPopupCustomControl)),this.ABPPopupCustomControl.prepareABP(!1)},b.prototype.onExtActive=function(){this.navTo("billing.DefferedPmtExt",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum})},b.prototype.onRBBActive=function(){this.ABPPopupCustomControl?this.ABPPopupCustomControl._oABPPopup.setTitle("RETRO AVERAGE BILLING PLAN: ACTIVATE"):(this.ABPPopupCustomControl=new h({isRetro:!0}),this.ABPPopupCustomControl._oABPPopup.setTitle("RETRO AVERAGE BILLING PLAN: ACTIVATE"),this.ABPPopupCustomControl.attachEvent("ABPCompleted",function(){},this),this.getView().addDependent(this.ABPPopupCustomControl)),this.ABPPopupCustomControl.prepareABP(!0)},b.prototype.onMessages=function(a){var b,c,e,f,g,h,i=this;a&&a.getSource&&a.getSource().getBindingContext&&a.getSource().getBindingContext("comp-billing")&&a.getSource().getBindingContext("comp-billing").getProperty("DunningReason").indexOf("OTBD")>=0?(h=new d,this._sContract=this._coNum,this._sBP=this._bpNum,this._sCA=this._caNum,this.getView().addDependent(h),h.openQuickPay(this._sContract,this._sBP,this._sCA,"PBD"),h.attachEvent("PaymentCompleted",function(){i._initRetrBillInvoices(),i._initPostInvoice(),i._initBillingMsgs()},this)):a.getSource().getBindingContext("comp-billing").getProperty("DunningReason").indexOf("OTCC")>=0?(h=new d,this._sContract=this._coNum,this._sBP=this._bpNum,this._sCA=this._caNum,this.getView().addDependent(h),h.openQuickPay(this._sContract,this._sBP,this._sCA,"PCC"),h.attachEvent("PaymentCompleted",function(){i._initRetrBillInvoices(),i._initPostInvoice(),i._initBillingMsgs()},this)):(this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("DunnlingLocks","nrg.module.billing.view.DunningPopup",this)),void 0===this._oDunningDialog&&(this._oDunningDialog=new ute.ui.main.Popup.create({title:"Dunning",content:this._oDialogFragment})),b=a.getSource().getBindingContext("comp-billing").getPath()+"/DunningLocksSet",e=sap.ui.core.Fragment.byId("DunnlingLocks","idnrgBillDn-Table"),f=sap.ui.core.Fragment.byId("DunnlingLocks","idnrgBillDn-Row"),g=function(){i.getOwnerComponent().getCcuxApp().setOccupied(!1)},c={model:"comp-billing",path:b,template:f,events:{dataReceived:g}},this.getView().addDependent(this._oDunningDialog),this._oDunningDialog.addStyleClass("nrgCamHis-dialog"),e.bindRows(c),this._oDunningDialog.open())},b.prototype._onUnbilled=function(){var a,b,c,d,e,f,g,h="/UnbilledS",i=this,j=this.getOwnerComponent().getModel("comp-billing");i.getOwnerComponent().getCcuxApp().setOccupied(!0),c=["BP","CA","Contract"],d=[this._bpNum,this._caNum,this._coNum],e=this._createSearchFilterObject(c,d),this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("Unbilled","nrg.module.billing.view.PaymentsPopup",this)),void 0===this._oUnbilledDialog&&(this._oUnbilledDialog=new ute.ui.main.Popup.create({title:"Unbilled AR Item List",content:this._oDialogFragment})),a=sap.ui.core.Fragment.byId("Unbilled","idnrgUnbiilled-Table"),b=sap.ui.core.Fragment.byId("Unbilled","idnrgUnbiilled-Row"),f=function(){var b=a.getBinding("rows");a&&a.getRows()&&a.getRows().length>0?i._oUnbilledDialog.open():sap.ui.commons.MessageBox.alert("No Records found"),i.getOwnerComponent().getCcuxApp().setOccupied(!1),b&&b.detachDataReceived(f)},a.setModel(j,"comp-billing"),g={model:"comp-billing",path:h,filters:e,template:b,events:{dataReceived:f}},a.bindRows(g)},b.prototype.onUnbilledClose=function(){this._oUnbilledDialog.close()},b.prototype._formatPostInvoice=function(a,b){return a?"Payment"===a?a+" on "+b:a:""},j});