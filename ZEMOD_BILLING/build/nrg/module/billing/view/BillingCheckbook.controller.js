sap.ui.define(["jquery.sap.global","nrg/base/view/BaseController","nrg/base/type/Price","nrg/module/quickpay/view/QuickPayPopup","nrg/module/billing/view/EligPopup","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(a,b,c,d,e,f,g){"use strict";var h=b.extend("nrg.module.billing.view.BillingCheckbook");return h.prototype.onInit=function(){},h.prototype.onBeforeRendering=function(){this.getOwnerComponent().getCcuxApp().setTitle("BILLING"),this.getOwnerComponent().getCcuxApp().setOccupied(!0),this._initRoutingInfo();var a=(this.getOwnerComponent().getModel("comp-feeAdjs"),this),b=this.getOwnerComponent().getGlobalDataManager();b.isPrepay()?a._coNum?a.navTo("billing.PrePayCheckBook",{bpNum:a._bpNum,caNum:a._caNum,coNum:this._coNum}):a.navTo("billing.PrePayCheckBookNoCo",{bpNum:a._bpNum,caNum:a._caNum}):a.PostPaidAccounts()},h.prototype.PostPaidAccounts=function(){this.getView().setModel(this.getOwnerComponent().getModel("comp-billing"),"oDataSvc"),this.getView().getModel("oDataSvc").setSizeLimit(200),this.getView().setModel(this.getOwnerComponent().getModel("comp-eligibility"),"oDataEligSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oChkbkHdr"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPaymentHdr"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oPostInvoiceItems"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this._initChkbookHdr(),this._initPaymentHdr(),this._initPostInvoiceItems(),this._retrieveNotification()},h.prototype.onAfterRendering=function(){var a=sap.ui.getCore().getEventBus();a.subscribe("nrg.module.billing","eABPCompleted",this._handleABPComplete,this)},h.prototype.onExit=function(){},h.prototype._handleABPComplete=function(){this.PostPaidAccounts()},h.prototype._formatPostClotGrn=function(a){return"G"===a?!0:!1},h.prototype._formatPostClotRed=function(a){return"R"===a?!0:!1},h.prototype._formatPostInv2VL=function(a,b){return"L"!==a||b?!1:!0},h.prototype._formatPostInv2VR=function(a,b){return"R"!==a||b?!1:!0},h.prototype._formatPostInv1V=function(a,b){return"H"!==a||b?!1:!0},h.prototype._formatDppIntGrn=function(a){return"G"===a?!0:!1},h.prototype._formatDppIntYlw=function(a){return"Y"===a?!0:!1},h.prototype._formatDppIntRed=function(a){return"R"===a?!0:!1},h.prototype._formatDppIntWte=function(a){return"W"===a?!0:!1},h.prototype._formatBoolHyperLink=function(a){return a?!0:!1},h.prototype._formatBoolDP=function(a){return"DP"===a?!0:!1},h.prototype._formatBoolLP=function(a){return"LP"===a?!0:!1},h.prototype._formatBoolBB=function(a){return"BB"===a?!0:!1},h.prototype._formatBoolCurChrg=function(a){return"X"===a||"x"===a?!0:!1},h.prototype._formatBoolNormalPitem=function(a,b){return a||b?!1:!0},h.prototype._formatTwoClotBoolean=function(a){return a?!0:!1},h.prototype._formatBppBoolean=function(a){return"BBP"===a?!0:!1},h.prototype._formatFirstClotBlk=function(a,b,c){return"BBP"===a?!1:c?!1:b?!1:!0},h.prototype._formatFirstClotGrn=function(a,b,c){return"BBP"===a?!1:c?!1:b?!0:!1},h.prototype._formatFirstClotRed=function(a,b,c){return"BBP"===a?!1:c?!0:b?!1:!1},h.prototype._formatClotTTCurrent=function(a,b,c){return"BBP"===a?!1:"RED"===b?!1:c?!0:!1},h.prototype._formatClotTTDppCncl=function(a,b){return"BBP"===a?!1:"RED"===b?!0:!1},h.prototype._formatClotTTDInactive=function(a,b,c){return"BBP"===a?!1:"RED"===b?!1:c?!1:!0},h.prototype._formatNotBppBoolean=function(a){return"BBP"===a?!1:!0},h.prototype._getCurDate=function(){var a,b=new Date;return a=(b.getMonth()+1).toString()+"/"+b.getDate().toString()+"/"+b.getFullYear().toString().substring(2,4)},h.prototype._getPreSixMonthDate=function(){var a,b=new Date;return b.setMonth(b.getMonth()-6),a=(b.getMonth()+1).toString()+"/"+b.getDate().toString()+"/"+b.getFullYear().toString().substring(2,4)},h.prototype._formatLfRtZroVal=function(a){return"0.00"===a||"0"===a?" ":a},h.prototype._onExpandAllClicked=function(){var b,c,d=this.getView().byId("nrgChkbookPmtHdrs"),e=this.getView().getModel("oPaymentHdr"),f=[],g=this.getView().byId("nrgChkbookScrollContainer");for(this.getOwnerComponent().getCcuxApp().setOccupied(!0),b=0;b<d.mAggregations.content.length;b+=1)d.mAggregations.content[b].setExpanded(!0),c=d.mAggregations.content[b].oBindingContexts.oPaymentHdr.sPath,this._retrPayments(e.getProperty(c).InvoiceNum,c),this._retrPaymentItmes(e.getProperty(c).InvoiceNum,c),f.push(a.Deferred()),this._retrPaymentSumryswResolve(e.getProperty(c).InvoiceNum,c,f[b]);a.when.apply(a,f).done(function(){window.setTimeout(function(){g.scrollTo(0,1e4,1e3)},2e3)})},h.prototype._retrPaymentSumryswResolve=function(a,b,c){var d,e,f,g=this.getView().getModel("oDataSvc");return d="/PaymentHdrs('"+a+"')/PaymentSumry",e={success:function(a){a&&a.results&&a.results.length>0&&this.getView().getModel("oPaymentHdr").setProperty(b+"/PaymentSumry",a.results[0]),c.resolve()}.bind(this),error:function(){c.resolve()}.bind(this)},g&&(f=g.read(d,e)),f},h.prototype._onCollapseAllClicked=function(){var a,b=this.getView().byId("nrgChkbookPmtHdrs");for(a=0;a<b.mAggregations.content.length-1;a+=1)b.mAggregations.content[a].setExpanded(!1)},h.prototype._onPaymentHdrClicked=function(a){var b,c=this.getView().getModel("oPaymentHdr");b=a.oSource.oBindingContexts.oPaymentHdr.getPath(),c.getProperty(b+"/bExpand")&&(this._retrPayments(c.getProperty(b).InvoiceNum,b),this._retrPaymentItmes(c.getProperty(b).InvoiceNum,b),this._retrPaymentSumrys(c.getProperty(b).InvoiceNum,b))},h.prototype._onPaymentOptionClick=function(){var a=new d;this.getView().addDependent(a),this._coNum&&a.openQuickPay(this._coNum,this._bpNum,this._caNum),a.attachEvent("PaymentCompleted",function(){this._initChkbookHdr(),this._initPaymentHdr(),this._initPostInvoiceItems(),this._retrieveNotification()},this)},h.prototype._onHighBillFactorClick=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.HighBill",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.HighBillNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onLiteUpLinkClicked=function(){var a="http://www.puc.state.tx.us/consumer/lowincome/Assistance.aspx";window.open(a)},h.prototype._retrPayments=function(a,b){var c,d,e=this.getView().getModel("oDataSvc");c="/PaymentHdrs('"+a+"')/Payments",d={success:function(a){this.getOwnerComponent().getCcuxApp().setOccupied(!1),a&&this.getView().getModel("oPaymentHdr").setProperty(b+"/Payments",a)}.bind(this),error:function(){this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},e&&e.read(c,d)},h.prototype._retrPaymentItemDppTable=function(a,b,c){var d,e,f=this.getView().getModel("oDataSvc");d="/PaymentItems(ContractAccountNumber='',InvoiceNum='"+a+"',Opbel='"+b+"')/DPPPlan",e={success:function(a){a&&this.getView().getModel("oPaymentHdr").setProperty(c+"/DpInstls",a)}.bind(this),error:function(){}.bind(this)},f&&f.read(d,e)},h.prototype._retrPaymentItmes=function(a,b){var c,d,e,f=this.getView().getModel("oDataSvc");c="/PaymentHdrs('"+a+"')/PaymentItems",d={success:function(a){if(a&&a.results&&a.results.length>0)for(this.getView().getModel("oPaymentHdr").setProperty(b+"/PaymentItems",a),e=0;e<a.results.length;e+=1)"DP"===a.results[e].HyperLinkInd&&this._retrPaymentItemDppTable(a.results[e].InvoiceNum,a.results[e].Opbel,b+"/PaymentItems/results/"+e.toString())}.bind(this),error:function(){}.bind(this)},f&&f.read(c,d)},h.prototype._retrPaymentSumrys=function(a,b){var c,d,e,f=this.getView().getModel("oDataSvc");return c="/PaymentHdrs('"+a+"')/PaymentSumry",d={success:function(a){a&&a.results&&a.results.length>0&&this.getView().getModel("oPaymentHdr").setProperty(b+"/PaymentSumry",a.results[0])}.bind(this),error:function(){}.bind(this)},f&&(e=f.read(c,d)),e},h.prototype._initRoutingInfo=function(){var a=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum},h.prototype._initChkbookHdr=function(){var a;a="/ChkBookHdrs(ContractAccountID='"+this._caNum+"',InvoiceNum='')",this._retrChkbookHdr(a)},h.prototype._initPaymentHdr=function(){var a;a="/ConfBuags('"+this._caNum+"')/PaymentHdrs",this._retrPaymentHdr(a)},h.prototype._initPostInvoiceItems=function(){var a;a="/ConfBuags('"+this._caNum+"')/PostInvoice",this._retrPostInvoiceItems(a)},h.prototype._retrChkbookHdr=function(a){var b,c=this.getView().getModel("oDataSvc");b={success:function(a){a&&this.getView().getModel("oChkbkHdr").setData(a)}.bind(this),error:function(){}.bind(this)},c&&c.read(a,b)},h.prototype._retrPaymentHdr=function(a){var b,c,d,e=this.getView().getModel("oDataSvc"),f=new Date,g=(this.getView().byId("nrgChkbookScrollContainer"),this),h=this.getView().getModel("oChkbkHdr");b={success:function(a){var b=h.getProperty("/InvAmount");if(b=parseFloat(b?b:"0.00"),a&&a.results&&a.results.length>0){for(c=0;c<a.results.length;c+=1){if(a.results[c].oCallOut={},a.results[c].CallOut){for(a.results[c].oCallOut=JSON.parse(a.results[c].CallOut),a.results[c].bRed=!1,d=0;d<a.results[c].oCallOut.CallOuts.length;d+=1)"BBP"===a.results[c].oCallOut.CallOuts[d].CallOut&&(a.results[c].oCallOut.CallOuts[d].BBPAmt=a.results[c].BBPAmt,a.results[c].oCallOut.CallOuts[d].BBPAmtAddr=a.results[c].BBPAmtAddr,a.results[c].oCallOut.CallOuts[d].BBPBal=a.results[c].BBPBal,a.results[c].oCallOut.CallOuts[d].BBPBalAddr=a.results[c].BBPBalAddr,a.results[c].oCallOut.CallOuts[d].BBPDefBal=a.results[c].BBPDefBal,a.results[c].oCallOut.CallOuts[d].BBPDefBalTxt=a.results[c].BBPDefBalTxt),"RED"===a.results[c].oCallOut.CallOuts[d].Color&&(a.results[c].bRed=!0),a.results[c].oCallOut.CallOuts[d].bCurrent=c===a.results.length-1?!0:!1;1===a.results[c].oCallOut.CallOuts.length?a.results[c].sCallOut=a.results[c].oCallOut.CallOuts[0].CallOut:2===a.results[c].oCallOut.CallOuts.length?(a.results[c].sCallOut=a.results[c].oCallOut.CallOuts[0].CallOut,a.results[c].sCallOut2=a.results[c].oCallOut.CallOuts[1].CallOut):(a.results[c].sCallOut=a.results[c].oCallOut.CallOuts.length+"+",this.getView().byId("ChkbookHdrClOt").setVisible(!0))}c!==a.results.length-1?(a.results[c].bExpand=!1,a.results[c].bExpand_0=!1):(a.results[c].bExpand=!0,a.results[c].bExpand_0=!0),!a.results[c].Color||"R"!==a.results[c].Color&&"r"!==a.results[c].Color?!a.results[c].Color||"Y"!==a.results[c].Color&&"y"!==a.results[c].Color?(a.results[c].bRegul=!0,a.results[c].bAlert=!1,a.results[c].bYellow=!1):(a.results[c].bRegul=!1,a.results[c].bAlert=!1,a.results[c].bYellow=!0):(a.results[c].bRegul=!1,a.results[c].bAlert=!0,a.results[c].bYellow=!1)}c-=1,a.results[c]&&a.results[c].DueDate&&a.results[c].DueDate<f&&b>0&&(a.results[c].bAlert=!0,a.results[c].bRegul=!1,a.results[c].bYellow=!1),a.results[c]&&a.results[c].DueDate&&a.results[c].DueDate>f&&b>0&&(a.results[c].bAlert=!1,a.results[c].bRegul=!1,a.results[c].bYellow=!0),this.getView().getModel("oPaymentHdr").setData(a),this._retrPayments(a.results[c].InvoiceNum,"/results/"+c),this._retrPaymentSumrys(a.results[c].InvoiceNum,"/results/"+c),this._retrPaymentItmes(a.results[c].InvoiceNum,"/results/"+c)}else this.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){g.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this)},e&&e.read(a,b)},b.prototype._createSearchFilterObject=function(a,b){var c,d=[];for(c=0;c<a.length;c+=1)d.push(new f(a[c],g.EQ,b[c],""));return d},h.prototype._retrPostInvoiceItems=function(a){var b,c,d,e,f,g=this.getView().getModel("oDataSvc"),h=this.getView().byId("nrgChkbookScrollContainer");d=["IsCheckBook"],e=[!0],f=this._createSearchFilterObject(d,e),b={filters:f,success:function(a){if(a&&a.results&&a.results.length>0)for(this.getView().getModel("oPostInvoiceItems").setData(a),c=0;c<a.results.length;c+=1)"DP"===a.results[c].HyperLinkInd&&this._retrPostInvoiceItemDppTable(a.results[c].InvoiceNum,a.results[c].Opbel,"/results/"+c.toString());window.setTimeout(function(){h.scrollTo(0,1e3,1e3)},2e3)}.bind(this),error:function(){}.bind(this)},g&&g.read(a,b)},h.prototype._retrPostInvoiceItemDppTable=function(a,b,c){var d,e,f=this.getView().getModel("oDataSvc"),g=this.getView().byId("nrgChkbookScrollContainer");d="/PostInvoices(ContractAccountNumber='"+this._caNum+"',InvoiceNum='',Opbel='"+b+"')/DPPPlans",e={success:function(a){a&&this.getView().getModel("oPostInvoiceItems").setProperty(c+"/DpInstls",a),g.scrollTo(0,1e3,1e3)}.bind(this),error:function(){}.bind(this)},f&&f.read(d,e)},h.prototype._onBackToBilling=function(){var a=this.getOwnerComponent().getRouter();this._coNum?a.navTo("billing.BillingInfo",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):a.navTo("billing.BillingInfoNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._retrieveNotification=function(){var a,b,c,d,e="/EligCheckS('"+this._coNum+"')",f=this.getView().getModel("oDataEligSvc"),g=this.getView().getModel("oEligibility"),h=this.getOwnerComponent().getModel("comp-i18n-billing");a={success:function(a){g.setData(a);var e=this.getView().byId("nrgBilling-billChkBook-notifications");for(e&&e.getContent()&&e.getContent().length>0&&e.removeAllContent(),this._eligibilityAlerts=[],a.ABPElig?(("Y"===a.ABPElig||"y"===a.ABPElig)&&(d=h.getProperty("nrgNotfABPT")),("N"===a.ABPElig||"n"===a.ABPElig)&&(d=h.getProperty("nrgNotfABPF")),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:d,linkPress:this._openEligABPPopup.bind(this)})):b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:h.getProperty("nrgNotfABPEmpty"),linkPress:this._reloadNotification.bind(this)}),this._eligibilityAlerts.push(b),a.EXTNElig?(("Y"===a.EXTNElig||"y"===a.ABPElig)&&(d=h.getProperty("nrgNotfEXTT")),("N"===a.EXTNElig||"n"===a.ABPElig)&&(d=h.getProperty("nrgNotfEXTF")),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:d,linkPress:this._openEligABPPopup.bind(this)})):b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:h.getProperty("nrgNotfEXTEmpty"),linkPress:this._reloadNotification.bind(this)}),this._eligibilityAlerts.push(b),a.RBBElig?(("Y"===a.RBBElig||"y"===a.ABPElig)&&(d=h.getProperty("nrgNotfRBPT")),("N"===a.RBBElig||"n"===a.ABPElig)&&(d=h.getProperty("nrgNotfRBPF")),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:d,linkPress:this._openEligABPPopup.bind(this)})):b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:h.getProperty("nrgNotfRBPEmpty"),linkPress:this._reloadNotification.bind(this)}),this._eligibilityAlerts.push(b),a.DPPElig?(("Y"===a.DPPElig||"y"===a.ABPElig)&&(d=h.getProperty("nrgNotfDPPT")),("N"===a.DPPElig||"n"===a.ABPElig)&&(d=h.getProperty("nrgNotfDPPF")),b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:d,linkPress:this._openEligABPPopup.bind(this)})):b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:h.getProperty("nrgNotfDPPEmpty"),linkPress:this._reloadNotification.bind(this)}),this._eligibilityAlerts.push(b),("Y"===a.EXTNPend||"y"===a.EXTNPend)&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:h.getProperty("nrgNotfPE")}),this._eligibilityAlerts.push(b)),("Y"===a.CollAccActv||"y"===a.CollAccActv)&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:h.getProperty("nrgNotfCB")}),this._eligibilityAlerts.push(b)),("Y"===a.CSAActv||"y"===a.CSAActv)&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:h.getProperty("nrgNotfCSA")}),this._eligibilityAlerts.push(b)),("Y"===a.RBankDActv||"y"===a.RBankDActv)&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:h.getProperty("nrgNotfRBD")}),this._eligibilityAlerts.push(b)),("Y"===a.RCCardActv||"y"===a.RCCardActv)&&(b=new ute.ui.app.FooterNotificationItem({link:!1,design:"Information",text:h.getProperty("nrgNotfRCC")}),this._eligibilityAlerts.push(b)),c=0;c<this._eligibilityAlerts.length;c+=1)this._eligibilityAlerts[c].placeAt(e)}.bind(this),error:function(){var a=this.getView().byId("nrgBilling-billChkBook-notifications");a&&a.getContent()&&a.getContent().length>0&&a.removeAllContent(),this._eligibilityAlerts=[],b=new ute.ui.app.FooterNotificationItem({link:!0,design:"Information",text:h.getProperty("nrgNotfReload"),linkPress:this._reloadNotification.bind(this)}),this._eligibilityAlerts.push(b),this._eligibilityAlerts[0].placeAt(a)}.bind(this)},f&&this._coNum&&f.read(e,a)},h.prototype._reloadNotification=function(){this._retrieveNotification()},h.prototype._openEligABPPopup=function(){this.EligABPPopupCustomControl||(this.EligABPPopupCustomControl=new e({eligType:"ABP"}),this.EligABPPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligABPPopupCustomControl),this.EligABPPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - AVERAGE BILLING PLAN")),this.EligABPPopupCustomControl.prepare()},h.prototype._openEligEXTNPopup=function(){this.EligEXTNPopupCustomControl||(this.EligEXTNPopupCustomControl=new e({eligType:"EXTN"}),this.EligEXTNPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligEXTNPopupCustomControl),this.EligEXTNPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - EXTENSION")),this.EligEXTNPopupCustomControl.prepare()},h.prototype._openEligRBBPopup=function(){this.EligRBBPopupCustomControl||(this.EligRBBPopupCustomControl=new e({eligType:"RBB"}),this.EligRBBPopupCustomControl.attachEvent("EligCompleted",function(){},this),this.getView().addDependent(this.EligRBBPopupCustomControl),this.EligRBBPopupCustomControl._oEligPopup.setTitle("ELIGIBILITY CRITERIA - RETRO BILLING PLAN")),this.EligRBBPopupCustomControl.prepare()},h});