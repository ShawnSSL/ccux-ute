sap.ui.define(["jquery.sap.global","nrg/base/view/BaseController","sap/ui/model/json/JSONModel","nrg/module/quickpay/view/QuickPayPopup","sap/ui/model/Filter","sap/ui/model/FilterOperator","nrg/module/dashboard/view/ReconnectPopup"],function(a,b,c,d,e,f,g){"use strict";var h=b.extend("nrg.module.billing.view.CustomerDataPrePD");return h.prototype.onInit=function(){},h.prototype.onBeforeRendering=function(){this.getOwnerComponent().getCcuxApp().setTitle("BILLING"),this._initRouting(),this._loadPrepayData(),this._initBillingMsgs()},h.prototype._loadPrepayData=function(){var b,c=this.getOwnerComponent().getModel("comp-feeAdjs"),d="/PrepaySet(BP='"+this._bpNum+"',CA='"+this._caNum+"')",e=this;this.getOwnerComponent().getCcuxApp().setOccupied(!0),b={success:function(){e.getView().bindElement({model:"comp-feeAdjs",path:d}),e.getOwnerComponent().getCcuxApp().setOccupied(!1),a.sap.log.info("Odata Read Successfully:::")}.bind(this),error:function(){e.getOwnerComponent().getCcuxApp().setOccupied(!1),a.sap.log.info("Odata Error occured")}.bind(this)},c&&c.read(d,b)},h.prototype.onAfterRendering=function(){this.getOwnerComponent().getCcuxApp().showNavLeft(!0),this.getOwnerComponent().getCcuxApp().attachNavLeft(this._navLeftCallBack,this),this.getOwnerComponent().getCcuxApp().showNavRight(!0),this.getOwnerComponent().getCcuxApp().attachNavRight(this._navRightCallBack,this)},b.prototype._navLeftCallBack=function(){var a=this.getOwnerComponent().getRouter();this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCaCo",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):!this._coNum&&this._caNum&&this._bpNum?a.navTo("dashboard.VerificationWithCa",{bpNum:this._bpNum,caNum:this._caNum}):this._coNum||this._caNum||!this._bpNum||a.navTo("dashboard.Verification",{bpNum:this._bpNum})},b.prototype._navRightCallBack=function(){},h.prototype.onExit=function(){},h.prototype.onPayNow=function(){var a=new d,b=this;this._sContract=this._coNum,this._sBP=this._bpNum,this._sCA=this._caNum,this.getView().addDependent(a),a.openQuickPay(this._sContract,this._sBP,this._sCA),a.attachEvent("PaymentCompleted",function(){b._loadPrepayData()},this)},h.prototype._initRouting=function(){var a=this.getOwnerComponent().getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum},b.prototype._createSearchFilterObject=function(a,b){var c,d=[];for(c=0;c<a.length;c+=1)d.push(new e(a[c],f.EQ,b[c],""));return d},h.prototype._onChkbookLnkClicked=function(){this._coNum?this.navTo("billing.PrePayCheckBook",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):this.navTo("billing.PrePayCheckBookNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onHighbillLnkClicked=function(){this._coNum?this.navTo("billing.HighBill",{bpNum:this._bpNum,caNum:this._caNum,coNum:this._coNum}):this.navTo("billing.HighBillNoCo",{bpNum:this._bpNum,caNum:this._caNum})},h.prototype._onCommPreferences=function(){var b,d,e,f,g,h,i=this.getOwnerComponent().getModel("comp-commprefs"),j=this;this.getOwnerComponent().getCcuxApp().setOccupied(!0),g=["BP","CA"],h=[this._bpNum,this._caNum],f=this._createSearchFilterObject(g,h),this._oDialogFragment||(this._oDialogFragment=sap.ui.xmlfragment("CommPref","nrg.module.billing.view.CommPref",this)),void 0===this._oCommDialog&&(this._oCommDialog=new ute.ui.main.Popup.create({title:"Communication Preferences",content:this._oDialogFragment})),b="/PrepayCommPrefS",e=sap.ui.core.Fragment.byId("CommPref","idnrgCommPrefTag"),e.setModel(new c,"view-custpref"),d={filters:f,success:function(b){e.getModel("view-custpref").setData(b),j._oCommDialog.open(),a.sap.log.info("Odata Read Successfully:::"),j.getOwnerComponent().getCcuxApp().setOccupied(!1)}.bind(this),error:function(){j.getOwnerComponent().getCcuxApp().setOccupied(!1),a.sap.log.info("oData Error occured")}.bind(this)},i&&i.read(b,d)},h.prototype._onReconnect=function(){this.ReconnectPopupControl||(this.ReconnectPopupControl=new g({isRetro:!0}),this.ReconnectPopupControl.attachEvent("ReConnectCompleted",function(){},this),this.getView().addDependent(this.ReconnectPopupControl)),this.ReconnectPopupControl.open()},h.prototype._onAlertInformation=function(){var a,b,c,d,e,f,g,h,i=this.getOwnerComponent().getModel("comp-feeAdjs"),j=this;this.getOwnerComponent().getCcuxApp().setOccupied(!0),e=["CA"],f=[this._caNum],d=this._createSearchFilterObject(e,f),this._oAlertsFragment||(this._oAlertsFragment=sap.ui.xmlfragment("PPAlerts","nrg.module.billing.view.PrePayAlerts",this)),void 0===this._oAlertsDialog&&(this._oAlertsDialog=new ute.ui.main.Popup.create({title:"Alert Information",content:this._oAlertsFragment})),a="/PpAlertS",c=sap.ui.core.Fragment.byId("PPAlerts","idnrgBilling-Alerts"),g=sap.ui.core.Fragment.byId("PPAlerts","idnrgBilling-AlertsTemp"),c.setModel(i,"comp-feeAdjs"),h=function(){var a=c.getBinding("rows");j.getOwnerComponent().getCcuxApp().setOccupied(!1),a&&a.getLength()>0?j._oAlertsDialog.open():sap.ui.commons.MessageBox.alert("No Data Available"),a&&a.detachDataReceived(h)},b={model:"comp-feeAdjs",path:a,filters:d,template:g,events:{dataReceived:h}},c.bindRows(b)},h.prototype.onChanged=function(a){var b=a.getSource().getBindingContext("view-custpref").getPath(),c=sap.ui.core.Fragment.byId("CommPref","idnrgCommPrefTag"),d=c.getModel("view-custpref");d.setProperty(b+"/Changed",!0)},h.prototype._onCPCancel=function(){this._oCommDialog.close()},h.prototype._onCPSubmit=function(){var a,b=sap.ui.core.Fragment.byId("CommPref","idnrgCommPrefTag"),c=b.getModel("view-custpref"),d=c.oData.results,e=this.getOwnerComponent().getModel("comp-commprefs"),f="/PrepayCommPrefS",g=0,h=0,i=0;this.getOwnerComponent().getCcuxApp().setOccupied(!0),d.forEach(function(a){var b=f;a.Changed&&(g+=1,b=b+"(BP='"+a.BP+"',CA='"+a.CA+"',AttrSet='"+a.AttrSet+"')",e.update(b,{Call:a.Call,Email:a.Email,SMS:a.SMS},{success:function(){i+=1},error:function(){h+=1},merge:!1}))}),a=setInterval(function(){i+h===g&&(ute.ui.main.Popup.Alert(i===g?{title:"Information",message:"Communication preferences updated Successfully"}:{title:"Information",message:"Communication preferences update Failed"}),this._oCommDialog.close(),clearInterval(a),this.getOwnerComponent().getCcuxApp().setOccupied(!1))}.bind(this),100)},h.prototype._initBillingMsgs=function(){var a,b,c,d,e,f=this.getView().byId("idnrgBillingMsgs"),g=this.getView().byId("idnrgBillingMsgsTemp"),h=this.getView().byId("idnrgBilDunMsgs"),i=this.getView().byId("idnrgBilDunMsgsTemp"),j="/AlertsSet";f.unbindAggregation("content",!1),h.unbindAggregation("content",!1),a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"BILLING"],c=this._createSearchFilterObject(a,b),d={model:"comp-billing",path:j,template:g,filters:c},f.bindAggregation("content",d),a=["BP","CA","Identifier"],b=[this._bpNum,this._caNum,"DUNNING"],c=this._createSearchFilterObject(a,b),e={model:"comp-billing",path:j,template:i,filters:c},h.bindAggregation("content",e)},h});