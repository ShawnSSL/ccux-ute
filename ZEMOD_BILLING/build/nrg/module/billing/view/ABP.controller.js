sap.ui.define(["nrg/base/view/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","jquery.sap.global","sap/ui/model/json/JSONModel","nrg/base/type/Price","nrg/module/billing/view/control/AverageBillDetailsChart"],function(a,b,c,d,e,f,g){"use strict";var h=a.extend("nrg.module.billing.view.ABP");return h.prototype.onInit=function(){var a=sap.ui.getCore().getEventBus();a.subscribe("nrg.module.billing","eOpenABPPopup",this._handleOpenABPPopup,this)},h.prototype._handleOpenABPPopup=function(){this._OwnerComponent=this.getView().getParent().getParent().getParent().getController().getOwnerComponent(),this._ABPPopupControl=this.getView().getParent(),this._aYearList=[],this._aGraphClors=["blue","gray","yellow"],this.getView().setModel(this._OwnerComponent.getModel("comp-billing-avgplan"),"oDataAvgSvc"),this.getView().setModel(this._OwnerComponent.getModel("comp-dppext"),"oDataSvc"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oEligibility"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oUsageGraph"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oAmountBtn"),this.getView().setModel(new sap.ui.model.json.JSONModel,"oAmountHistory"),this.getView().setModel(new sap.ui.model.json.JSONModel({current:!1,newAdd:!1,co:"",HouseNo:"",UnitNo:"",City:"",State:"",Country:"",AddrLine:"",Street:"",PoBox:"",ZipCode:"",NewAddrCheck:!1,NewAddressflag:!1,editable:!1}),"olocalAddress"),this.getView().setModel(new e,"oDppStepThreeCom"),this.getView().setModel(new e,"oABPScrnControl"),this._initScrnControl();var a=this._OwnerComponent.getCcuxRouteManager().getCurrentRouteInfo();this._bpNum=a.parameters.bpNum,this._caNum=a.parameters.caNum,this._coNum=a.parameters.coNum,this._initialCheck()},h.prototype._initScrnControl=function(){var a=this.getView().getModel("oABPScrnControl");a.setProperty("/Table",!0),a.setProperty("/Graph",!0),a.setProperty("/Note",!0),a.setProperty("/Correspondence",!1),a.setProperty("/Trillium",!1)},h.prototype._selectScrn=function(a,b){var c=this.getView().getModel("oABPScrnControl");a&&(c.setProperty("/Table",!1),c.setProperty("/Graph",!1),c.setProperty("/Note",!1),c.setProperty("/Correspondence",!0),c.setProperty("/Trillium",!1),this._retrDppComunication()),b&&(c.setProperty("/Table",!1),c.setProperty("/Graph",!1),c.setProperty("/Note",!1),c.setProperty("/Correspondence",!1),c.setProperty("/Trillium",!0))},h.prototype._retrieveTableInfo=function(a,d){var e,f,g,h,i,j="/AvgAddS",k=[],l=this.getView().getModel("oDataAvgSvc"),m=this.getView().getModel("oAmountHistory"),n=[];k.push(new b({path:"Contract",operator:c.EQ,value1:a})),f={filters:k,success:function(a){if(a.results&&a.results.length>0){for(g=0;g<a.results.length;g+=1)"Total"!==a.results[g].Period?(h={},i=a.results[g].Period,h=a.results[g],h.Period=h.Period.substr(0,2)+"/"+h.Period.substr(6,4),h.FullPeriod=i,h.ActualBill=parseFloat(h.ActualBill),h.Usage=parseFloat(h.Usage),h.AdjAmount=parseFloat(h.Adjsmnt),h.AmtUsdAbp=parseFloat(h.AmtUsdAbp),n.push(h)):e=parseFloat(a.results[g].AmtUsdAbp);m.setData(n),m.setProperty("/totalAmount",e),m.setProperty("/estAmount","$"+parseFloat(a.results[0].Estimate).toFixed(2)),d&&d()}else ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Customer had no Billing History"}),this._ABPPopupControl.close()}.bind(this),error:function(){}.bind(this)},l&&l.read(j,f)},h.prototype._retrieveGraphInfo=function(a,d){var e,f,g,h="/AvgUsgS",i=[],j=this.getView().getModel("oDataAvgSvc"),k=this.getView().getModel("oUsageGraph"),l=[];i.push(new b({path:"Contract",operator:c.EQ,value1:a})),e={filters:i,success:function(a){if(a.results){for(f=0;f<a.results.length;f+=1)g={},g.usageDate=a.results[f].Period,g.usage=parseInt(a.results[f].Consumption,10),l.push(g);k.setProperty("/data",l),d&&d()}}.bind(this),error:function(){}.bind(this)},j&&j.read(h,e)},h.prototype._retrieveABPEligibility=function(a,b){var c,d,e=this.getView().getModel("oDataAvgSvc"),f=this.getView().getModel("oEligibility");c="/EligibilityS(Contract='"+a+"',IsRetro="+this.isRetro+")",d={success:function(a){f.setData(a),a.ABPAct?(f.setProperty("/Activated",!0),f.setProperty("/NonActivated",!1)):(f.setProperty("/Activated",!1),f.setProperty("/NonActivated",!0)),b&&b()}.bind(this),error:function(){f.setProperty("/ABPElig",!1),b&&b()}.bind(this)},e&&e.read(c,d)},h.prototype._initialCheck=function(){var a,b,c,e=this.getView().getModel("oEligibility"),f=this._OwnerComponent.getCcuxWebUiManager(),h=!1,i=!1,j=!1;return this._coNum?(this._OwnerComponent.getCcuxApp().setOccupied(!0),this._retrieveABPEligibility(this._coNum,function(){j=!0,this._OwnerComponent.getCcuxApp().setOccupied(!1)}.bind(this)),b=setInterval(function(){var k,l;if(j){if(clearInterval(b),this._OwnerComponent.getCcuxApp().setOccupied(!0),e.oData.ABPAct)return this._ABPPopupControl.close(),f.notifyWebUi("openIndex",{LINK_ID:"Z_AVGBIL_D"}),this._OwnerComponent.getCcuxApp().setOccupied(!1),void clearTimeout(c);if(e.oData.ABPElig){if(e.oData.NoBillHistory)return this._ABPPopupControl.close(),ute.ui.main.Popup.Alert({title:"ABP",message:"Customer has no Billing History"}),this._OwnerComponent.getCcuxApp().setOccupied(!1),void clearTimeout(c);for(this._ABPPopupControl.open(),this._retrieveTableInfo(this._coNum,function(){h=!0}),this._retrieveGraphInfo(this._coNum,function(){i=!0}),k=0;k<this.getView().byId("nrgBilling-avgBillingPopup-usage-control").getContent().length;k+=1)l=this.getView().byId("nrgBilling-avgBillingPopup-usage-control").getContent()[k],l.getContent()[0].setChecked(!0);a=setInterval(function(){if(h&&i){if(this._OwnerComponent.getCcuxApp().setOccupied(!1),clearInterval(a),clearTimeout(c),!this.graphControl){var b=this.getView().byId("nrgBilling-avgBillingPopup-usage-graph");this.graphControl=new g("chart",{width:700,height:250,usageTickSize:200}),this.graphControl.placeAt(b),this._ABPPopupControl.$().offset({top:(d(window).height()-this._ABPPopupControl.getDomRef().offsetHeight-250)/2})}this.graphControl.setDataModel(this.getView().getModel("oUsageGraph")),this._renderGraphCrontrolBtn()}}.bind(this),100)}else this._ABPPopupControl.close(),ute.ui.main.Popup.Alert({title:"Not Eligible",message:"You are not eligible for Average Billing Plan."}),this._OwnerComponent.getCcuxApp().setOccupied(!1),clearTimeout(c)}}.bind(this),100),c=setTimeout(function(){ute.ui.main.Popup.Alert({title:"Network service failed",message:"We cannot retrieve your data. Please try again later."}),clearInterval(a),this._OwnerComponent.getCcuxApp().setOccupied(!1)}.bind(this),3e4),void 0):(this._ABPPopupControl.close(),void ute.ui.main.Popup.Alert({title:"Contract Not Found",message:"Customer is not eligible."}))},h.prototype._onCancelBtnClick=function(){this._ABPPopupControl.close()},h.prototype._onCalBtnClick=function(){var a,b,c,d,e,f=this.getView().getModel("oDataAvgSvc"),g=this.getView().getModel("oAmountHistory"),h={},i=this,j="";for(i._OwnerComponent.getCcuxApp().setOccupied(!0),h.Contract=this._coNum,b=0;b<g.oData.length;b+=1)c="Prd"+this._pad(b+1),d="Bbs"+this._pad(b+1),e="Amt"+this._pad(b+1),h[c]=g.oData[b].FullPeriod,h[d]=g.oData[b].Basis,h[e]=(parseFloat(g.oData[b].AdjAmount)||0).toString(),j=0===b?g.oData[b].Status:j+"~"+g.oData[b].Status;if(g.oData.length<12)for(b=g.oData.length;12>b;b+=1)c="Prd"+this._pad(b+1),d="Bbs"+this._pad(b+1),e="Amt"+this._pad(b+1),h[c]="0.0",h[d]="0.0",h[e]="0.0",j+="~NA";h.Status=j,f&&(a={method:"POST",urlParameters:h,success:function(a){var b,c="0";if(i._OwnerComponent.getCcuxApp().setOccupied(!1),"S"===a.Code){for(b=0;b<g.oData.length;b+=1)c=g.getProperty("/"+b+"/AdjAmount"),!isNaN(parseFloat(c))&&isFinite(c)&&parseInt(c,10)>0&&g.setProperty("/"+b+"/AmtUsdAbp",g.getProperty("/"+b+"/AdjAmount"));g.setProperty("/estAmount","$"+parseFloat(a.Message).toFixed(2)),g.setProperty("/totalAmount","$"+parseFloat(a.Info).toFixed(2))}else ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){i._OwnerComponent.getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},f.callFunction("/ABPCalc",a))},h.prototype._onSetBtnClick=function(){var a,b=this.getView().getModel("oDataAvgSvc"),c=this.getView().getModel("oAmountHistory"),d=this,e=c.getProperty("/estAmount");e&&(e=e.replace("$","")),this._OwnerComponent.getCcuxApp().setOccupied(!0),b&&(a={method:"POST",urlParameters:{Contract:this._coNum,Date:c.oData[0].FullPeriod,IsRetro:this.isRetro,AbpAmt:e},success:function(a){d._OwnerComponent.getCcuxApp().setOccupied(!1),"S"===a.Code?(ute.ui.main.Popup.Alert({title:"Success",message:"ABP activation success and contact log has been created."}),this._selectScrn(!0)):ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){d._OwnerComponent.getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},b.callFunction("/ABPCrte",a))},h.prototype._onDeactBtnClick=function(){var a,b=this.getView().getModel("oDataAvgSvc"),c=(this.getView().getModel("oAmountHistory"),this);c._OwnerComponent.getCcuxApp().setOccupied(!0),b&&(a={method:"POST",urlParameters:{Contract:this._coNum},success:function(a){c._OwnerComponent.getCcuxApp().setOccupied(!1),"S"===a.Code?(this._ABPPopupControl.close(),ute.ui.main.Popup.Alert({title:"Success",message:"You have canceled the ABP successfully."}),this._retrieveABPEligibility(this._coNum)):ute.ui.main.Popup.Alert({title:"Request failed",message:a.Message})}.bind(this),error:function(){c._OwnerComponent.getCcuxApp().setOccupied(!1),ute.ui.main.Popup.Alert({title:"Request failed",message:"The request cannot be sent due to the network or the oData service."})}.bind(this)},b.callFunction("/ABPCanc",a))},h.prototype.onSelected=function(a){var b=a.getSource(),c=this._aYearList[parseInt(b.getId().replace(this.getView().getId()+"--nrgBilling-avgBillingPopup-graphControlChkbox-",""),10)].toString(),d=b.getChecked(),e=this.graphControl;e&&e.hideUsage(c,!d)},h.prototype._renderGraphCrontrolBtn=function(){var a,b,c,d=this.getView().getModel("oUsageGraph");if(d.oData.data.length)for(a=0;a<d.oData.data.length;a+=1)c=d.oData.data[a].usageDate.split("/"),this._aYearList.indexOf(c[2])<0&&this._aYearList.push(c[2]);for(b=0;b<this._aYearList.length;b+=1)this.getView().byId("nrgBilling-avgBillingPopup-graphControlBtn-"+b).setVisible(!0),this.getView().byId("nrgBilling-avgBillingPopup-graphControlText-"+b).setText(this._aYearList[b]).addStyleClass("usageChartLegend-label-"+this._aGraphClors[b])},h.prototype._pad=function(a){return 10>a?"0"+a.toString():a.toString()},h.prototype.onPopupClose=function(){this.getView().getParent().close()},h.prototype._onPoBoxEdit=function(){var a=this.getView().getModel("olocalAddress");a.setProperty("/HouseNo",""),a.setProperty("/Street","")},h.prototype._onComAddrCheck=function(){this.getView().getModel("olocalAddress").setProperty("/current",!0),this.getView().getModel("olocalAddress").setProperty("/newAdd",!1)},h.prototype._onCurrentAddCheck=function(){this.getView().getModel("olocalAddress").setProperty("/Address/co",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/co")),this.getView().getModel("olocalAddress").setProperty("/Address/HouseNo",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/HouseNo")),this.getView().getModel("olocalAddress").setProperty("/Address/UnitNo",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/UnitNo")),this.getView().getModel("olocalAddress").setProperty("/Address/City",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/City")),this.getView().getModel("olocalAddress").setProperty("/Address/State",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/State")),this.getView().getModel("olocalAddress").setProperty("/Address/Country",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/Country")),this.getView().getModel("olocalAddress").setProperty("/Address/Street",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/Street")),this.getView().getModel("olocalAddress").setProperty("/Address/PoBox",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/PoBox")),this.getView().getModel("olocalAddress").setProperty("/Address/ZipCode",this.getView().getModel("oDppStepThreeCom").getProperty("/Address/ZipCode")),this.getView().getModel("olocalAddress").setProperty("/NewAddrCheck",!1),this.getView().getModel("olocalAddress").setProperty("/NewAddressflag",!1),this.getView().getModel("olocalAddress").setProperty("/editable",!1)},h.prototype._onNewAddCheck=function(){this.getView().getModel("olocalAddress").setProperty("/Address/co",""),this.getView().getModel("olocalAddress").setProperty("/Address/HouseNo",""),this.getView().getModel("olocalAddress").setProperty("/Address/UnitNo",""),this.getView().getModel("olocalAddress").setProperty("/Address/City",""),this.getView().getModel("olocalAddress").setProperty("/Address/State",""),this.getView().getModel("olocalAddress").setProperty("/Address/Country",""),this.getView().getModel("olocalAddress").setProperty("/Address/Street",""),this.getView().getModel("olocalAddress").setProperty("/Address/PoBox",""),this.getView().getModel("olocalAddress").setProperty("/Address/ZipCode",""),this.getView().getModel("olocalAddress").setProperty("/NewAddrCheck",!0),this.getView().getModel("olocalAddress").setProperty("/NewAddressflag",!0),this.getView().getModel("olocalAddress").setProperty("/editable",!0)},h.prototype._postDPPCommunication=function(){var a=this.getView().getModel("oDppStepThreeCom"),b=a.oData,c=this.getView().getModel("olocalAddress");if(b.eMailCheck&&!b.eMail)return ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Email field is empty"}),!0;if(b.FaxCheck){if(!b.Fax)return ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter Fax Number"}),!0;if(!b.FaxTo)return ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter Fax To"}),!0}return b.AddrCheck&&c.getProperty("/newAdd")?c.getProperty("/Address/HouseNo")&&c.getProperty("/Address/Street")||c.getProperty("/Address/PoBox")?c.getProperty("/Address/City")?c.getProperty("/Address/State")?c.getProperty("/Address/ZipCode")?c.getProperty("/Address/Country")?(this._TrilliumAddressCheck(),!0):(ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter country"}),!0):(ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter zip Code"}),!0):(ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter state"}),!0):(ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter city"}),!0):(ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Please enter street no & street name or PO Box"}),!0):(this._sendDppComunication(),!0)},h.prototype._compareSuggChkClicked=function(a){var b,c=this.getView().byId("idAddrUpdatePopup-l").getContent(),d=this.getView().byId("idAddrUpdatePopup-r").getContent();if(a.mParameters.checked)for(b=1;8>b;b+=1)c[b].getContent()[0].getValue()!==d[b].getContent()[0].getValue()&&(c[b].getContent()[0].addStyleClass("nrgABP-cusDataVerifyEditMail-lHighlight"),d[b].getContent()[0].addStyleClass("nrgABP-cusDataVerifyEditMail-rHighlight"));else for(b=1;8>b;b+=1)c[b].getContent()[0].getValue()!==d[b].getContent()[0].getValue()&&(c[b].getContent()[0].removeStyleClass("nrgABP-cusDataVerifyEditMail-lHighlight"),d[b].getContent()[0].removeStyleClass("nrgABP-cusDataVerifyEditMail-rHighlight"))},h.prototype._TrilliumAddressCheck=function(){var a,b,c=this.getView().getModel("olocalAddress"),d=this._OwnerComponent.getModel("comp-bupa"),e=this._createAddrValidateFilters();c.setProperty("/updateSent",!0),c.setProperty("/showVldBtns",!0),c.setProperty("/updateNotSent",!1),a="/BuagAddrDetails",b={filters:e,success:function(a){"X"===a.results[0].AddrChkValid?this._sendDppComunication():(c.setProperty("/SuggAddrInfo",a.results[0].TriCheck),this._showSuggestedAddr(),this._selectScrn(!1,!0))}.bind(this),error:function(){sap.ui.commons.MessageBox.alert("Validatation Call Failed")}.bind(this)},d&&d.read(a,b)},h.prototype._showSuggestedAddr=function(){var a=this.getView().getModel("olocalAddress");a.setProperty("/updateSent",!0),a.setProperty("/showVldBtns",!0),a.setProperty("/updateNotSent",!1)},h.prototype._createAddrValidateFilters=function(){var a,d,e,f=[],g=this.getView().getModel("olocalAddress"),h=g.getProperty("/Address");a=new b({path:"FixUpd",operator:c.EQ,value1:"X"}),f.push(a),a=new b({path:"PartnerID",operator:c.EQ,value1:this._bpNum}),f.push(a),a=new b({path:"ChkAddr",operator:c.EQ,value1:"X"}),f.push(a);for(d in h)h.hasOwnProperty(d)&&"__metadata"!==d&&"StandardFlag"!==d&&"ShortForm"!==d&&"ValidFrom"!==d&&"ValidTo"!==d&&"Supplement"!==d&&(e="FixAddrInfo/"+d,a=new b({path:e,operator:c.EQ,value1:h[d]}),f.push(a));return f},h.prototype._sendDppComunication=function(){var a,b,c=this.getView().getModel("oDataSvc"),d=this.getView().getModel("oDppStepThreeCom"),e=d.oData,f=this.getView().getModel("olocalAddress");b="/DPPCorresps",a={merge:!1,success:function(a){ute.ui.main.Popup.Alert(a.Error?a.Message?{title:"AVERAGE BILLING",message:a.Message}:{title:"AVERAGE BILLING",message:"Correspondence Failed"}:{title:"AVERAGE BILLING",message:"Correspondence Successfully Sent."}),this._ABPPopupControl.close()}.bind(this),error:function(){ute.ui.main.Popup.Alert({title:"AVERAGE BILLING",message:"Correspondence Failed"})}.bind(this)},c&&(d.oData.Process="ABP",f.getProperty("/newAdd")&&(e.Address.HouseNo=f.getProperty("/Address/HouseNo"),e.Address.UnitNo=f.getProperty("/Address/UnitNo"),e.Address.City=f.getProperty("/Address/City"),e.Address.State=f.getProperty("/Address/State"),e.Address.Country=f.getProperty("/Address/Country"),e.Address.AddrLine=f.getProperty("/Address/AddrLine"),e.Address.Street=f.getProperty("/Address/Street"),e.Address.PoBox=f.getProperty("/Address/PoBox"),e.Address.ZipCode=f.getProperty("/Address/ZipCode"),e.NewAddr=f.getProperty("/NewAddrCheck")),c.create(b,d.oData,a))},h.prototype._retrDppComunication=function(){var a,b,c=this.getView().getModel("oDataSvc"),d="ABP",e=this.getView().getModel("olocalAddress");b="/DPPCorresps(CA='"+this._caNum+"',Contract='"+this._coNum+"',BP='"+this._bpNum+"',Process='"+d+"')",a={success:function(a){e.oData;a&&(this.getView().getModel("oDppStepThreeCom").setData(a),a.AddrCheck&&(e.setProperty("/current",!0),e.setProperty("/newAdd",!1)),a.Address&&(e.setProperty("/Address",{}),e.setProperty("/Address/co",a.Address.co),e.setProperty("/Address/HouseNo",a.Address.HouseNo),e.setProperty("/Address/UnitNo",a.Address.UnitNo),e.setProperty("/Address/City",a.Address.City),e.setProperty("/Address/State",a.Address.State),e.setProperty("/Address/Country",a.Address.Country),e.setProperty("/Address/Street",a.Address.Street),e.setProperty("/Address/PoBox",a.Address.PoBox),e.setProperty("/Address/ZipCode",a.Address.ZipCode)))}.bind(this),error:function(){}.bind(this)},c&&c.read(b,a)},h.prototype._handleMailingAcceptBtn=function(){var a=this.getView().getModel("olocalAddress"),b=a.Address,c=a.Address;b=c,this._sendDppComunication()},h.prototype._handleMailingDeclineBtn=function(){this._sendDppComunication()},h.prototype._handleMailingEditBtn=function(){var a=this.getView().getModel("olocalAddress");a.setProperty("/updateSent",!1),a.setProperty("/showVldBtns",!1),a.setProperty("/updateNotSent",!0)},h});